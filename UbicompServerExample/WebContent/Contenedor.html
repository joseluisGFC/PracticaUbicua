<!DOCTYPE html>
<html>
<head>
	<meta charset="ISO-8859-1">
	<script src="./js/libs/jquery/jquery.min.js"></script>  
	<script src="./js/libs/charts/Chart.min.js"></script>
	<title>Server example</title>
	<style>
		table {
		  font-family: arial, sans-serif;
		  border-collapse: collapse;
		  width: 100%;
		}
		
		td, th {
		  border: 1px solid #dddddd;
		  text-align: left;
		  padding: 8px;
		}
		
		tr:nth-child(even) {
		  background-color: #dddddd;
		}
	</style>
</head>
<body>
	<script>
    $(document).ready(function() 
       	 {        	 
       		boton=document.getElementById("buscar");
       		boton2=document.getElementById("mostrar");
       		boton.addEventListener("click",tomar,false);
       		boton2.addEventListener("click",stats,false);
            });
            
      function tomar(){
           	id_contenedor = document.getElementById("id_c").value;
           	loadDetails();
       }
      
      function stats(){
    	  tipoSensor = document.getElementById("tipo").value;
    	  mostrar();
     }
         
 	  function loadDetails()
        {
       	 $.ajax(
      		 {
      			data:  {id_contenedor:id_contenedor},
      			url:   "GetContenedorById",//el serverlet que te da la info
      			type:  'post',
      			async: false,
      			success:  function (response) 
      			{	
      				var resp = JSON.parse(response);
      				console.log(resp);
      				$("#dataTable").empty();
      				var newRow = "";
      				$.each(resp, function (i, value) 
					{
          				newRow += "<tr>";
          				newRow += "<td>" + value.id + "</td>";   
          				newRow += "<td>" + value.latitude + "</td>"; 
          				newRow += "<td>" + value.longitude + "</td>"; 
          				newRow += "</tr>";	
  					});  
      				$("#dataTable").append(newRow);
      			}
      		});
        }
 	  
		function mostrar()
        {
 	       	 $.ajax(
 	      		 {
 	      			data:  {id_contenedor:id_contenedor,tipoSensor: tipoSensor},
 	      			url:   "GetMedidasFromContenedorFromSensor",//el serverlet que te da la info
 	      			type:  'post',
 	      			async: false,
 	      			success:  function (response) 
 	      			{	
 	      				var resp = JSON.parse(response);
 	      				console.log(resp);
 	      				var values = [];
 	      				var labels = [];
 	      				$.each(resp, function (i, value) 
 						{
 	      				values.push(value.value);
 	      				labels.push(value.dateMeasurement);
 	  					});  
 	      				var Ourmedia = media(values);
 	      				var Ourmoda = moda(values);
 	      				var Ourdes = desviacionTipica(values,Ourmedia);
 	      				var pred = (Ourmedia * 0.9 + values[values.length - 1] * 0.1);
 	      				var newRow = "";
 	      				$("#StatsTable").empty();
         				newRow += "<tr>";
         				newRow += "<td>" + Ourmedia + "</td>"; 
         				newRow += "<td>" + Ourmoda + "</td>";  
         				newRow += "<td>" + Ourdes + "</td>"; 
         				newRow += "<td>" + pred + "</td>"; 
         				newRow += "</tr>";	
         				$("#StatsTable").append(newRow);
         				crearGraph(labels,values);
 	      			}
 	      		});
 	    }

       function media(Ourvalues){
           var sum = 0;
           for (var i = 0; i < Ourvalues.length; i++) {
               sum += Ourvalues[i];
           }
           return sum / Ourvalues.length;
       }
       
       function moda(Ourvalues) {
           var maxValue=0, maxCount=0;

           for (var i = 0; i < Ourvalues.length; ++i) {
               var count = 0;
               for (var j = 0; j < Ourvalues.length; ++j) {
                   if (Ourvalues[j] == Ourvalues[i]) ++count;
               }
               if (count > maxCount) {
                   maxCount = count;
                   maxValue = Ourvalues[i];
               }
           }

           return maxValue;
       }
       
       function desviacionTipica(Ourvalues,valuesMedia){
           var sum = 0;
           for (var i = 0; i < Ourvalues.length; i++) {
           	var dentro = Ourvalues[i]-valuesMedia;
               sum += Math.pow(dentro,2);
           }
           return Math.sqrt(sum / Ourvalues.length);
       } 		
       
       
       function crearGraph(Ourlabels, Ourvalues){
      	 canvas=document.getElementById("myCanvas");
      	 var context = canvas.getContext('2d');
      	 context.clearRect(0, 0, canvas.width, canvas.height);
      	 var myLineChart = new Chart(canvas, {
      		    type: 'line',
      		    data: {
      		        labels: Ourlabels,
      		        datasets: [{
      		            label: 'My First dataset',
      		            data: Ourvalues
      		        }]
      		    },
      		    options: {
      		        maintainAspectRatio: false
      		    }
      	});
       }
         
         
	</script>
	<h1>SERVER EXAMPLE</h1>
	<br>
	
	<div id="menu">
		<nav class="menucss">
			<a href="index.html">Main</a>
			<a href="sensores.html">Sensores</a>
			<a href="Medida.html">Medida</a>
			<a href="Pro.html">Pro</a>
			<a href="graph.html">Graph</a>
			<a href="Map.html">Map</a>
			<a href="Alertas.html">Alertas</a>
			<a href="stats.html">Stats</a>
		</nav>
	</div>
	
	<div id="contenedor">
		<section id="cajabuscador">
			<form name="buscador" autocomplete="off">
				<p>Contenedor:<br><input type="text" id="id_c" name="id_c"></p>
				<p><input type="button" name="buscar" id="buscar" value="Buscar"></p>
			</form>
		</section>
	</div>	

	<table class="table">
		<thead>
		    <tr>
		      <th scope="col">Id</th>
		      <th scope="col">latitud</th>
		      <th scope="col">longitud</th>
		    </tr>
		</thead>
		<tbody id="dataTable">
		</tbody>
	</table>	
	
	<div id="contenedorS">
		<section id="cajabuscadorS">
			<form name="buscador" autocomplete="off">
				<p>Tipo de sensor:<br><input type="text" id="tipo" name="tipo"></p>
				<p><input type="button" name="mostrar" id="mostrar" value="Mostrar"></p>
			</form>
		</section>
	</div>	
	
	<table class="table">
		<thead>
		    <tr>
		      <th scope="col">Media</th>
		      <th scope="col">Moda</th>
		      <th scope="col">Desviacion Tipica</th>
		      <th scope="col">Prediccion del siguiente dia</th>
		    </tr>
		</thead>
		<tbody id="StatsTable">
		</tbody>
	</table>
		<div  style="height: 500px">
		<canvas id="myCanvas"></canvas>
	</div>		
</body>
</html>